(function() {
    "use strict";

    var extTitle = "Orion - localStorage";
    var log=function(c,b){if("object"===typeof console&&"function"===typeof console.error&&"function"===typeof console.info&&"function"===typeof console.warn){var a;"object"===typeof c?(c.unshift("["+extTitle+"]\n"),a=c):a=["["+extTitle+"]\n"+c];if("undefined"===typeof b||"alerta"!==b.toLowerCase()&&"aviso"!==b.toLowerCase())if("undefined"!==typeof b&&"info"===b.toLowerCase())try{console.info.apply(console,a)}catch(d){console.info(a.join("\n"))}else try{console.error.apply(console,a)}catch(e){console.error(a.join("\n"))}else try{console.warn.apply(console, a)}catch(f){console.warn(a.join("\n"))}}};

    window.orionLocalStorage = window.orionLocalStorage || {};

    var support = typeof localStorage !== "undefined" && typeof localStorage.setItem !== "undefined" && typeof localStorage.getItem !== "undefined";

    window.orionLocalStorage.setItem = function(key, value, expirationMinutes) {
        try{
            if(!support)
                return false;

            var dt = new Date();
            localStorage.setItem(key, value);

            if(!isNaN(parseInt(expirationMinutes))){
                dt.setTime(dt.getTime() + (expirationMinutes * 60 * 1000));
                localStorage.setItem(key + "_expiration", dt.getTime());
            }
        }
        catch(e){
            log(["Erro ao salvar os dados: ", e.message], "alerta");
        };
    };

    window.orionLocalStorage.getItem = function(key) {
        try{
            if(!support)
                return false;

            var dt = new Date();
            var expiration = parseInt((localStorage.getItem(key + "_expiration") || 0), 10) || 0;

            if(dt.getTime() > expiration){
                if(localStorage.removeItem){
                    localStorage.removeItem(key);
                    localStorage.removeItem(key + "_expiration");
                }
                return null;
            }

            return localStorage.getItem(key);
        }
        catch(e){
            log(["Erro ao salvar os dados: ", e.message], "alerta");
        };
    };
})();

(function () {

    try {
        // localStorage.removeItem("dagProductData_1746");
        // localStorage.removeItem("dagProductData_1746_expiration");
        let PBMstorefront = {
            init: () => {
                // Storefront element
                PBMstorefront.getProductInfo();
                PBMstorefront.consultCPF();

                // Integration
                PBMstorefront.verifyToken();

                // Validations
                PBMstorefront.applyMaskCPF();

                // Buttons Events
                PBMstorefront.buttonsConfigs();

                PBMstorefront.closeAcceptModal();
            },
            windowOnload: () => {},
            ajaxStop: () => {},
            dataToken: {},
            getProductInfo: () => {
                // let url = 'https://t.gopharma.com.br/?t=XUlk6XMp36w,tc2b.com/97';
                // let iframe = `<iframe src="${url}"></iframe>`;
                // $(".dag-terms-modal.instruction").html($(iframe));
                // $(document.body).addClass("term-modal-on");

                // let text = 'Atenção! Necessário aceitar termo de participação do Programa da  Indústria. COD:H119';
                // let blockText = `<p>${text}</p>`;
                // $(".dag-messages-pbm.descriptions").html(blockText);
                // $(document.body).addClass("messages-modal-on");

                let shelfs = $(".dag-shelf-wrapper li[layout] .dag-storefront.main");
                shelfs.each(async function () {
                    let $t = $(this);
                    let thisId = $t.attr("product-id"); // id do produto

                    // Verifico se está no cache
                    if (orionLocalStorage.getItem("dagProductData_"+thisId)) {
                        $t.find(".block-btn-promotion.info-discount").addClass("active-info-discount");
                        
                    } else {
                        let resp = await getProduct(thisId); // request
                        let prodData = resp[0];

                        // Verifico se faz parte do programa
                        if (prodData.productPbmOn && prodData.productPbmOn && prodData.productPbmOn == 'S') {
                            console.log(`Prod: ${prodData.productId} DENTRO! no programa, Salvando...`);
                            console.log(prodData);

                            // Mostrando no Front
                            $t.find(".block-btn-promotion.info-discount").addClass("active-info-discount");

                            // Salvando no Cache
                            window.orionLocalStorage.setItem("dagProductData_" + prodData.productId, JSON.stringify(prodData), 120);

                            // Preparando os dados do produto para consulta
                            let dataEAN = {
                                "EAN": prodData.items[0].ean,
                                "requestedQuantity": $t.find(".block-buybutton.quantity input").val(),
                                "listPrice": prodData.items[0].sellers[0].commertialOffer.ListPrice,
                                "netPrice": prodData.items[0].sellers[0].commertialOffer.Price,
                                "discountType": "B"
                            }
                            console.log(dataEAN);

                            // Consultando
                            PBMstorefront.consultProduct(dataEAN);
                        } 
                        
                        // console.log(`Prod: ${prodData.productId} FORA do programa.`);
                    }

                });
                async function getProduct (id) {
                    return $.ajax({
                        type: "GET",
                        url: "/api/catalog_system/pub/products/search/?fq=productId:"+id,
                        dataType: "json",
                        contentType: "application/json",
                        headers: { 
                            "Content-Type": "application/json",
                            "Accept": "application/vnd.vtex.ds.v10+json"
                        }
                    });
                }
            },
            consultProduct: (dataEAN) => {
                let bodyRequest = {
                    "control": {
                        "clientId": "36C0ED06-5F33-448C-96E4-A5AE1AAD3142",
                        "username": "A5FB2147-D606-6DEA-8314-17D5644B19D3",
                        "tableId": "37303932-3232-3131-3134-393933333632",
                        "localNumber": "1",
                        "localHour": "1",
                        "industryId": "999",
                        "stationId": "1",
                        "companyCode": "99999994001998",
                        "tableVersion": "",
                        "tableImage": ""
                    },
                    "product": [ dataEAN ]
                }
                let token = $.cookie("dagInterplayersToken");
                // async function sendConsult (id) {
                //     return $.ajax({
                //         type: "POST",
                //         url: "https://api-mng.interplayers.com.br/varejo40/transaction/v2/consultaproduto",
                //         headers: { 
                //             "Content-Type": "application/json",
                //             "Accept": "application/vnd.vtex.ds.v10+json"
                //         },
                //         data: bodyRequest
                //     });
                // }
            },
            verifyToken: () => {
                // Verificação Token
                if ($.cookie("dagInterplayersToken")) {
                    let tokenDate = $.cookie("dagInterplayersToken_expiration");
                    tokenDate = new Date(tokenDate);
                    let currentDate = new Date();
                    if (currentDate < tokenDate) {
                        console.log("Token Existe!");
                        return;
                    } else {
                        console.log("Limpando coockie.");
                        $.removeCookie("dagInterplayersToken");
                        $.removeCookie("dagInterplayersToken_expiration");
                    }
                }

                PBMstorefront.getToken();
            },
            getToken: () => {
                // Busca Token
                let dataJson = {
                    Client_Id: "36C0ED06-5F33-448C-96E4-A5AE1AAD3142",
                    Client_Secret: "VP2TQfEL#mF3!rsW",
                    Grant_Type: "client_credentials"
                }
                $.ajax({
                    type: "POST",
                    url: "https://api-mng.interplayers.com.br/gip-scs-svc/token",
                    data: dataJson
                }).done(function (response) {
                    PBMstorefront.dataToken = response;
                    let currentTime = PBMstorefront.dateConverterToBrazilTimezone();
                    $.cookie("dagInterplayersToken", response.access_token, { expires: 1 });
                    $.cookie("dagInterplayersToken_expiration", currentTime.toString(), { expires: 1 });
                });

            },
            applyMaskCPF: () => {
                $(".block-btn-promotion.input-cpf input").mask('000.000.000-00', {reverse: true});
            },
            buttonsConfigs: () => {

                // Buttons
                let btnBlockShowCPFField = $(".block-btn-promotion.info-discount");
                let btnAddDiscount = $(".dag-storefront-pbm-btn-add");
                let btnRemoveDiscount = $(".dag-storefront-pbm-btn-remove");
                let btnCloseBoxes = $(".dag-storefront.pbm-block .box-terms-btn-close");

                // Ação: Mostra o campo de preenchimento de CPF
                btnBlockShowCPFField.on("click", function (e) {
                    e.preventDefault();
                    let $t = $(this);

                    $t.removeClass("active-info-discount");
                    $t.siblings(".block-btn-promotion.input-cpf").addClass("active-input-cpf");
                });

                return;
                // Ação: Verifica o CPF na request e ativa o desconto se confirmado
                btnAddDiscount.on("click", function (e) {
                    e.preventDefault();
                    let $t = $(this);
                    
                    if ($t.prev().val().length < 14) {
                        alert("Numero de CPF incompleto.");
                        return;
                    }
                    
                    // Loader
                    let thisParent = $t.closest(".dag-storefront.main");
                    thisParent.addClass("pbm-loader-on");

                    thisParent.find(".dag-storefront.content").removeClass("content-on");
                    thisParent.find(".dag-storefront.discount-loader").addClass("active-loader-pbm");

                    setTimeout(function () {

                        // Default
                        // thisParent.find(".block-btn-promotion.discount-applied").addClass("active-discount-applied");
                        // thisParent.find(".block-btn-promotion.input-cpf").removeClass("active-input-cpf");
                        // thisParent.find(".dag-storefront.discount-loader").removeClass("active-loader-pbm");
                        // thisParent.removeClass("pbm-loader-on");
                        // thisParent.find(".dag-storefront.content").show();

                        // Cadastro
                        thisParent.find(".pbm-block.box-terms-register").addClass("active-box-terms-register");
                        thisParent.find(".block-btn-promotion.input-cpf").removeClass("active-input-cpf");
                        thisParent.find(".dag-storefront.discount-loader").removeClass("active-loader-pbm");
                        thisParent.removeClass("pbm-loader-on");
                        thisParent.find(".dag-storefront.content").addClass("content-on");

                        // Termo
                        // thisParent.find(".pbm-block.box-term-autorize").addClass("active-box-terms-autorize");
                        // thisParent.find(".block-btn-promotion.input-cpf").removeClass("active-input-cpf");
                        // thisParent.find(".dag-storefront.discount-loader").removeClass("active-loader-pbm");
                        // thisParent.removeClass("pbm-loader-on");
                        // thisParent.find(".dag-storefront.content").addClass("content-on");

                    }, 2000);

                });

                // Ação: Remove o desconto aplicado
                btnRemoveDiscount.on("click", function (e) {
                    e.preventDefault();
                    let $t = $(this);

                    // Loader
                    let thisParent = $t.closest(".dag-storefront.main");
                    thisParent.addClass("pbm-loader-on");
                    thisParent.find(".dag-storefront.content").hide();
                    thisParent.find(".dag-storefront.discount-loader").addClass("active-loader-pbm");

                    setTimeout(function () {
                        thisParent.find(".block-btn-promotion.discount-applied").removeClass("active-discount-applied");
                        thisParent.find(".block-btn-promotion.info-discount").addClass("active-info-discount");
                        thisParent.removeClass("pbm-loader-on");
                        thisParent.find(".dag-storefront.discount-loader").removeClass("active-loader-pbm");
                        thisParent.find(".dag-storefront.content").show();
                    }, 2000);
                });

                // Ação: Botão Fechar dos boxes (Cadastro e Autorizar)
                btnCloseBoxes.on("click", function (e) {
                    e.preventDefault();
                    let $t = $(this);

                    let thisParent = $t.closest(".dag-storefront.pbm-block");
                    thisParent.find(".box-terms-register, .box-term-autorize")
                        .removeClass("active-box-terms-register active-box-terms-autorize");

                    thisParent.find(".block-btn-promotion.info-discount").addClass("active-info-discount");
                });

            },
            // CPF submit
            consultCPF: () => {
                let btnCpf = $(".dag-storefront-pbm-btn-add");
                btnCpf.on("click", function (e) {
                    e.preventDefault();

                    let $t = $(this);
                    let CPF = $t.prev().val();
                    let id = $t.attr("field-product-id"); // id do produto

                    if (CPF.length < 14) {
                        alert("CPF Incompleto.");
                        return;
                    }
                    CPF = CPF.replace(/[^\w\s]/g, "");

                    let prodData = localStorage.getItem("dagProductData_"+id);
                    prodData = JSON.parse(prodData);
                    let lp = prodData.items[0].sellers[0].commertialOffer.ListPrice.toString();
                    let np = prodData.items[0].sellers[0].commertialOffer.Price.toString();
                    lp = lp.replace(".", "");
                    np = np.replace(".", "");
                    let prodInfo = {
                        "id": prodData.productId,
                        "packId": 0,
                        "EAN": prodData.items[0].ean,
                        "requestedQuantity": 1, 
                        "listPrice": lp,
                        "netPrice": np,
                        "discountType": "B"
                    }
                    PBMstorefront.verifyIfUserAcceptTerms(CPF, prodInfo);
                });
            },
            verifyIfUserAcceptTerms: (CPF, prodInfo) => {
                let token = $.cookie("dagInterplayersToken");
                let dataJson = {
                    "token": token,
                    "control": {
                        "clientId": "36C0ED06-5F33-448C-96E4-A5AE1AAD3142",
                        "username": "A5FB2147-D606-6DEA-8314-17D5644B19D3",
                        "tableId": "37303932-3232-3130-3330-393933333632",
                        "localNumber": 8888,
                        "centralNumber": 0,
                        "localHour": "2022-07-29T15:20:51", 
                        "industryId": "999",
                        "stationId": "",
                        "companyCode": "99999994001998",
                        "attendanceHash": "",
                        "terminalId": "ECOMMERCE"
                    },
                    "consumer": {
                        "holderId": CPF, 
                        "cardId": "" 
                    },
                    "product": [ prodInfo ]
                }
                // console.log(dataJson);
                $.ajax({
                    type: "POST",
                    url: "https://drogariaglobo-middleware.herokuapp.com/dagmiddleware/consult-discount",
                    data: dataJson
                }).done(function (response) {
                    let resp = response;
                    
                    console.log("RESPOSTA [CONSULTA PRODUTO]")
                    console.log(response);

                    // [1] - Aceite de termos
                    if (resp.returnCode == "H119") {
                        console.log("STATUS: H119");
                        let info = {
                            url: response.control.urlAcceptTerm,
                            text: response.informativeText
                        }
                        PBMstorefront.showAcceptTermsModal(info);
                    } 
                    // [2] - Cadastro
                    else if (resp.returnCode == "Q294") {
                        console.log("STATUS: Q294");
                        swal({
                            title: "Termos aceitos!",
                            text: "Agora o proximo passo é realizar seu cadastro, redirecionando para o formulario.",
                            icon: "success",
                            closeOnClickOutside: false
                        }).then(() => {
                            window.location.pathname = '/cadastro-programa';
                        });
                    } 
                    // [3] - Produto não vendido online
                    else if (resp.returnCode == "H127") {
                        swal({
                            title: "Atenção",
                            text: response.informativeText,
                            icon: "warning",
                            closeOnClickOutside: false
                        }).then(() => {
                            window.location.reload();
                        });
                    }
                    // if (resp && resp.control && resp.control.flowDeviation) {
                    //     if (resp.control.flowDeviation == "DESVIOURL") {
                    //     } else if (resp.control.flowDeviation.match("ATIVA")){
                    //     } else if (resp.control.flowDeviation == "") {
                    //     }
                    // }
                });

            },
            showAcceptTermsModal: (info) => {
                let iframe = `<iframe src="${info.url}"></iframe>`;
                $(".dag-terms-modal.block-terms-info").html(`<p>${info.text}</p>`);
                $(".dag-terms-modal.block-terms").html($(iframe));
                $(document.body).addClass("term-modal-on");

            },
            closeAcceptModal: () => {
                let btnCloseModal = $("#dag-btn-terms-modal-reload");
                btnCloseModal.on("click", function (e) {
                    e.preventDefault();

                    $(".dag-terms-modal.block-terms").empty();
                    $(document.body).removeClass("term-modal-on");
                });
            },
            // Utils
            dateConverterToBrazilTimezone: () => {
                // Conversor: Adiciona + 30 minutos da data atual para a expiração do token
                let date = new Date();
                date = new Date(date.getTime() + 30 * 60000);
                var iso = date.getFullYear().toString() + "-";
                iso += (date.getMonth() + 1).toString().padStart(2, '0') + "-";
                iso += date.getDate().toString().padStart(2, '0') + "T";
                iso += date.getHours().toString().padStart(2, '0') + ":";
                iso += date.getMinutes().toString().padStart(2, '0') + ":";
                iso += date.getSeconds().toString().padStart(2, '0');

                return iso;
            }
        };

        // Instanciando a funcao
        $(document).ready(PBMstorefront.init);
        let windowLoad = function () {
            PBMstorefront.windowOnload();
        };
        $(window).load(windowLoad);
        $(document).ajaxStop(PBMstorefront.ajaxStop);
        
    } catch (e) {
        console.log("Erro na instância do [PBMstorefront]: ", e);
    }

})();


// swal({
//     title: "Agradecemos seu cadastro!",
//     text: "Agora vamos te direcionar para página principal",
//     icon: "success",
//     closeOnClickOutside: false
// })